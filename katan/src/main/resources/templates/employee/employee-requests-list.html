<div th:fragment="content" id="employeeRequestsContent">
    <h4>Αιτήματα Υπηρεσίας</h4>

    <div th:if="${error != null}" class="alert alert-warning" th:text="${error}"></div>

    <div th:if="${#lists.isEmpty(requests)}">
        <p>Δεν υπάρχουν αιτήματα.</p>
    </div>

    <table th:if="${!#lists.isEmpty(requests)}" class="table table-striped">
        <thead>
        <tr>
            <th>Πρωτόκολλο</th>
            <th>Τίτλος</th>
            <th>Κατάσταση</th>
            <th>Ανατέθηκε σε</th>
            <th>Ενέργεια</th>
        </tr>
        </thead>

        <tbody>
        <tr th:each="r : ${requests}">
            <td th:text="${r.protocolNumber}"></td>
            <td th:text="${r.title}"></td>
            <td th:text="${r.status}"></td>

            <td>
                <span th:if="${r.assignedEmployee == null}" class="badge bg-secondary">
                    Χωρίς ανάθεση
                </span>
                <span th:if="${r.assignedEmployee != null}" class="badge bg-info"
                      th:text="${r.assignedEmployee.emailAddress}">
                </span>
            </td>

            <td>
                <div class="d-flex flex-column gap-2">
                    <!-- Ανάληψη (μόνο όταν είναι unassigned) -->
                    <form class="js-req-action" th:action="@{/employee/requests/{id}/claim(id=${r.id})}"
                          method="post"
                          onsubmit="event.preventDefault(); postFormAndReloadEmployeeRequests(this);">
                        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
                        <button type="submit" class="btn btn-sm btn-success">Ανάληψη</button>
                    </form>

                    <!-- Αποδέσμευση (μόνο όταν είναι δικό μου) -->
                    <form class="js-req-action" th:action="@{/employee/requests/{id}/unclaim(id=${r.id})}"
                          method="post"
                          onsubmit="event.preventDefault(); postFormAndReloadEmployeeRequests(this);">
                        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
                        <button type="submit" class="btn btn-sm btn-warning">Αποδέσμευση</button>
                    </form>

                    <!-- Status update (μόνο όταν είναι δικό μου) -->
                    <form th:if="${r.assignedEmployee != null and r.assignedEmployee.id == employeeId}"
                          th:action="@{/employee/requests/{id}/status(id=${r.id})}"
                          method="post"
                          class="d-flex gap-2"
                          onsubmit="event.preventDefault(); postFormAndReloadEmployeeRequests(this);">
                        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">

                        <select class="form-select form-select-sm" name="status" style="width: 160px;">
                            <option th:each="st : ${T(gr.hua.dit.my.city.gov.core.model.RequestStatus).values()}"
                                    th:value="${st}"
                                    th:text="${st}"
                                    th:selected="${st == r.status}">
                            </option>
                        </select>

                        <button class="btn btn-sm btn-primary">Αποθήκευση</button>
                    </form>
                    <!-- Απόφαση υπαλλήλου -->
                    <div th:if="${r.assignedEmployee != null and r.assignedEmployee.id == employeeId}"
                         class="border rounded p-2">

                        <div class="mb-1">
                            <strong>Απόφαση:</strong>
                            <span th:text="${r.employeeDecision != null ? r.employeeDecision : 'PENDING'}"></span>
                            <span class="text-muted ms-2"
                                  th:if="${r.employeeDecidedAt != null}"
                                  th:text="${#temporals.format(r.employeeDecidedAt, 'dd/MM/yyyy HH:mm')}">
                            </span>
                        </div>

                        <div class="small mb-2"
                             th:if="${r.employeeDecisionReason != null and !#strings.isEmpty(r.employeeDecisionReason)}">
                            <strong>Τεκμηρίωση:</strong>
                            <span th:text="${r.employeeDecisionReason}"></span>
                        </div>

                        <form class="js-req-action js-decision-form"
                              th:action="@{/employee/requests/{id}/decision(id=${r.id})}"
                              method="post"
                              onsubmit="event.preventDefault(); postFormAndReloadEmployeeRequests(this);">

                            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">

                            <select class="form-select form-select-sm mb-2 js-decision"
                                    name="decision" required>
                                <option th:each="d : ${T(gr.hua.dit.my.city.gov.core.model.EmployeeDecision).values()}"
                                        th:value="${d}"
                                        th:text="${d}"
                                        th:selected="${d == r.employeeDecision}">
                                </option>
                            </select>

                            <textarea class="form-control form-control-sm mb-2 js-reason"
                                      name="reason"
                                      rows="2"
                                      placeholder="Τεκμηρίωση απόφασης..."
                                      required></textarea>

                            <button class="btn btn-sm btn-outline-primary">
                                Υποβολή απόφασης
                            </button>
                        </form>
                    </div>
                    <!-- Σχόλια / Παρατηρήσεις -->
                    <div th:if="${r.assignedEmployee != null and r.assignedEmployee.id == employeeId}"
                         class="border rounded p-2">

                        <strong>Σχόλια</strong>

                        <form class="js-req-action mt-2"
                              th:action="@{/employee/requests/{id}/comment(id=${r.id})}"
                              method="post"
                              onsubmit="event.preventDefault(); postFormAndReloadEmployeeRequests(this);">

                            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">

                            <div class="d-flex gap-2">
                                <input type="text"
                                       class="form-control form-control-sm"
                                       name="text"
                                       placeholder="Γράψε σχόλιο..."
                                       maxlength="2000"
                                       required>

                                <button class="btn btn-sm btn-outline-secondary">
                                    Προσθήκη
                                </button>
                            </div>
                        </form>

                        <div class="mt-3 small"
                             th:if="${commentsByRequestId != null}">
                            <div th:each="c : ${commentsByRequestId[r.id]}">
                                <div class="text-muted">
                                    <span th:text="${c.authorEmployee.emailAddress}"></span>
                                    ·
                                    <span th:text="${#temporals.format(c.createdAt, 'dd/MM/yyyy HH:mm')}"></span>
                                </div>
                                <div th:text="${c.text}"></div>
                                <hr class="my-2">
                            </div>
                        </div>
                    </div>
                </div>
            </td>
        </tr>
        </tbody>
    </table>
</div>
